#from pre import utils
from os.path import join
import configparser
#configfile: 'config.yaml'

import os
print(os.environ['PATH'])

exp_dir = config['experiment_directory']
exp_conf_path = config.get('experiment_config','logs/config.cfg')
exp_conf_path = join(exp_dir, exp_conf_path)
exp_conf = configparser.ConfigParser()
exp_conf.read(exp_conf_path)

experiment_name = exp_conf.get('experiment','experiment name')
output_dir = join(config['output_directory'], experiment_name)
sections = exp_conf.options('sections')

rule all:
    input:
        expand('{dir}/processed_zarr/{s}.zarr', dir = output_dir, s = sections)

rule dummy:
    input:
        {exp_conf_path}
    output:
        'deleteme.out'
    conda:
        'envs/pyseq-image.yaml'
    log:
        'output/log.txt'
    shell:
        """
        which python > {log:q}
        echo $PATH >> {log:q} 2>&1
        touch {output:q}
        """

rule fix_lighting:
    input:
        {exp_conf_path},
        'deleteme.out'
    params:
        save_path = join(output_dir,'processed_zarr'),
        section = '{sections}'
    output:
        directory('{output_dir}/processed_zarr/{sections}.zarr')
       # '{output_dir}/processed_zarr/{sections}.attrs'
#    containerized: 'dockerfile'
    conda:
#        'pyseq_pipe'
        'envs/pyseq-image.yaml'
#    resources:
#	#jobs: len(sections)
#	partition: config.resources['partition']
#	mem: config.resources['mem']
#        time: config.resources['time']
    script:
        'scripts/preprocess.py'
